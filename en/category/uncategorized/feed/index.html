<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Uncategorized | Dev Tech</title>
	<atom:link href="https://sadewadee.pages.dev/en/category/uncategorized/feed/" rel="self" type="application/rss+xml" />
	<link>https://sadewadee.pages.dev/en</link>
	<description>Our latest news, updates, and stories for developers</description>
	<lastBuildDate>Fri, 04 Jun 2021 07:49:31 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.8.1</generator>

<image>
	<url>https://sadewadee.pages.dev/contents/uploads/2021/06/cropped-Tech.id_-32x32.png</url>
	<title>Uncategorized | Dev Tech</title>
	<link>https://sadewadee.pages.dev/en</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>Fast playback with audio and video preload</title>
		<link>https://sadewadee.pages.dev/en/fast-playback-with-audio-and-video-preload/</link>
					<comments>https://sadewadee.pages.dev/en/fast-playback-with-audio-and-video-preload/#respond</comments>
		
		<dc:creator><![CDATA[sadewadee]]></dc:creator>
		<pubDate>Fri, 04 Jun 2021 07:49:31 +0000</pubDate>
				<category><![CDATA[Uncategorized]]></category>
		<guid isPermaLink="false">http://optinlabs.my.id/blogs/fast-playback-with-audio-and-video-preload/</guid>

					<description><![CDATA[How to accelerate your media playback by actively preloading resources. Aug 17, 2017• Updated Nov 16, 2020 Appears in: Fast load times&#124;Media Faster playback start means more people watching your video or listening to your audio. That&#8217;s a known fact. In this article I&#8217;ll explore techniques you can use to accelerate your audio and video<a class="read-more" href="https://sadewadee.pages.dev/en/fast-playback-with-audio-and-video-preload/" title="More"> <span class="button"> Read More</span></a>]]></description>
										<content:encoded><![CDATA[<div>
<header class="w-article-header">
<p class="w-article-header__subhead w-mb--non">How to accelerate your media playback by actively preloading resources.</p>
<p><time>Aug 17, 2017</time><span class="w-author__separator">•</span> Updated <time>Nov 16, 2020</time></p>
<div class="w-layout-container--narrow w-post-signpost"><span class="w-post-signpost__title">Appears in:</span> <a href="/fast" class="w-post-signpost__link">Fast load times</a><span class="w-post-signpost__divider">|</span><a href="/media" class="w-post-signpost__link">Media</a></div>
<div class="w-authors w-mt--xl w-pt--sm">
<div class="w-author"><a href="/authors/beaufortfrancois"><img alt="François Beaufort" height="64" src="https://web-dev.imgix.net/image/admin/mXjY3z3JmrispGtu9yn6.jpg?auto=format&#038;fit=crop&#038;h=64&#038;w=64" width="64" class="w-author__image" loading="lazy" decoding="async" sizes="(min-width: 64px) 64px, calc(100vw - 48px)" srcset="https://web-dev.imgix.net/image/admin/mXjY3z3JmrispGtu9yn6.jpg?fit=crop&#038;h=64&#038;w=64&#038;auto=format&#038;dpr=1&#038;q=75, https://web-dev.imgix.net/image/admin/mXjY3z3JmrispGtu9yn6.jpg?fit=crop&#038;h=64&#038;w=64&#038;auto=format&#038;dpr=2&#038;q=50 2x, https://web-dev.imgix.net/image/admin/mXjY3z3JmrispGtu9yn6.jpg?fit=crop&#038;h=64&#038;w=64&#038;auto=format&#038;dpr=3&#038;q=35 3x, https://web-dev.imgix.net/image/admin/mXjY3z3JmrispGtu9yn6.jpg?fit=crop&#038;h=64&#038;w=64&#038;auto=format&#038;dpr=4&#038;q=23 4x, https://web-dev.imgix.net/image/admin/mXjY3z3JmrispGtu9yn6.jpg?fit=crop&#038;h=64&#038;w=64&#038;auto=format&#038;dpr=5&#038;q=20 5x"/></a></div>
</div>
</header>
<p>Faster playback start means more people watching your video or listening to your audio. <a href="https://www.digitaltrends.com/web/buffer-rage/">That&#8217;s a known fact</a>. In this article I&#8217;ll explore techniques you can use to accelerate your audio and video playback by actively preloading resources depending on your use case.</p>
<figure class="w-figure"><video class="w-screenshot" controls="" muted="" playsinline=""><source src="https://storage.googleapis.com/web-dev-assets/fast-playback-with-preload/video-preload-hero.webm#t=1.1" type="video/webm"><source src="https://storage.googleapis.com/web-dev-assets/fast-playback-with-preload/video-preload-hero.mp4#t=1.1" type="video/mp4"/></source></video><figcaption class="w-figcaption">
<p>Credits: copyright Blender Foundation | <a href="http://www.blender.org">www.blender.org </a>.</p>
</figcaption></figure>
<p>I&#8217;ll describe three methods of preloading media files, starting with their pros and cons.</p>
<table>
<tbody>
<tr>
<th/>
<th>It&#8217;s great&#8230;</th>
<th>But&#8230;</th>
</tr>
<tr>
<td rowspan="3" style="white-space: nowrap"><a href="#video_preload_attribute">Video preload attribute</a></td>
<td rowspan="3">Simple to use for a unique file hosted on a web server.</td>
<td>Browsers may completely ignore the attribute.</td>
</tr>
<tr>
<td>Resource fetching starts when the HTML document has been completely loaded and parsed.</td>
</tr>
<tr>
<td>Media Source Extensions (MSE) ignore the <code>preload</code> attribute on media elements because the app is responsible for providing media to MSE.</td>
</tr>
<tr>
<td rowspan="2" style="white-space: nowrap"><a href="#link_preload">Link preload</a></td>
<td>Forces the browser to make a request for a video resource without blocking the document&#8217;s <code>onload</code> event.</td>
<td>HTTP Range requests are not compatible.</td>
</tr>
<tr>
<td>Compatible with MSE and file segments.</td>
<td>Should be used only for small media files (<5 MB) when fetching full resources.</td>
</tr>
<tr>
<td><a href="#manual_buffering">Manual buffering</a></td>
<td>Full control</td>
<td>Complex error handling is the website&#8217;s responsibility.</td>
</tr>
</tbody>
</table>
<h2 id="video-preload-attribute">Video preload attribute <a href="#video-preload-attribute" class="w-headline-link">#</a></h2>
<p>If the video source is a unique file hosted on a web server, you may want to use the video <code>preload</code> attribute to provide a hint to the browser as to <a href="/video-and-source-tags/#preload">how much information or content to preload</a>. This means <a href="https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API">Media Source Extensions (MSE)</a> is not compatible with <code>preload</code>.</p>
<p>Resource fetching will start only when the initial HTML document has been completely loaded and parsed (e.g. the <code>DOMContentLoaded</code> event has fired) while the very different <code>load</code> event will be fired when resource has actually been fetched.</p>
<figure><img alt="" height="234" src="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/De8tMHJUn3XyzFfosVLb.svg" width="800" loading="lazy" decoding="async"/></figure>
<p>Setting the <code>preload</code> attribute to <code>metadata</code> indicates that the user is not expected to need the video, but that fetching its metadata (dimensions, track list, duration, and so on) is desirable. Note that starting in <a href="https://developers.google.com/web/updates/2017/12/chrome-63-64-media-updates#media-preload-defaults-metadata">Chrome 64</a>, the default value for <code>preload</code> is <code>metadata</code>. (It was <code>auto</code> previously).</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token operator"><</span>video id<span class="token operator">=</span><span class="token string">"video"</span> preload<span class="token operator">=</span><span class="token string">"metadata"</span> src<span class="token operator">=</span><span class="token string">"file.mp4"</span> controls<span class="token operator">></span><span class="token operator"><</span><span class="token operator">/</span>video<span class="token operator">></span><p><span class="token operator"><</span>script<span class="token operator">></span><br/>video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadedmetadata'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></p><p><span class="token keyword">const</span> bufferedSeconds <span class="token operator">=</span> video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>bufferedSeconds<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string"> seconds of video are ready to play.</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token operator"><</span><span class="token operator">/</span>script<span class="token operator">></span></p></code></pre>
<p></web-copy-code></p>
<p>Setting the <code>preload</code> attribute to <code>auto</code> indicates that the browser may cache enough data that complete playback is possible without requiring a stop for further buffering.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token operator"><</span>video id<span class="token operator">=</span><span class="token string">"video"</span> preload<span class="token operator">=</span><span class="token string">"auto"</span> src<span class="token operator">=</span><span class="token string">"file.mp4"</span> controls<span class="token operator">></span><span class="token operator"><</span><span class="token operator">/</span>video<span class="token operator">></span><p><span class="token operator"><</span>script<span class="token operator">></span><br/>video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadedmetadata'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></p><p><span class="token keyword">const</span> bufferedSeconds <span class="token operator">=</span> video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>bufferedSeconds<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string"> seconds of video are ready to play.</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token operator"><</span><span class="token operator">/</span>script<span class="token operator">></span></p></code></pre>
<p></web-copy-code></p>
<p>There are some caveats though. As this is just a hint, the browser may completely ignore the <code>preload</code> attribute. At the time of writing, here are some rules applied in Chrome:</p>
<ul>
<li>When <a href="https://support.google.com/chrome/answer/2392284">Data Saver</a> is enabled, Chrome forces the <code>preload</code> value to <code>none</code>.</li>
<li>In Android 4.3, Chrome forces the <code>preload</code> value to <code>none</code> due to an <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=612909">Android Bug</a>.</li>
<li>On a cellular connection (2G, 3G, and 4G), Chrome forces the <code>preload</code> value to <code>metadata</code>.</li>
</ul>
<h3 id="tips">Tips <a href="#tips" class="w-headline-link">#</a></h3>
<p>If your website contains many video resources on the same domain, I would recommend you set the <code>preload</code> value to <code>metadata</code> or define the <code>poster</code> attribute and set <code>preload</code> to <code>none</code>. That way, you would avoid hitting the maximum number of HTTP connections to the same domain (6 according to the HTTP 1.1 spec) which can hang loading of resources. Note that this may also improve page speed if videos aren&#8217;t part of your core user experience.</p>
<h2 id="link-preload">Link preload <a href="#link-preload" class="w-headline-link">#</a></h2>
<p>As <a href="https://developers.google.com/web/updates/2016/03/link-rel-preload">covered</a> in other <a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/">articles</a>, <a href="https://w3c.github.io/preload/">link preload</a> is a declarative fetch that allows you to force the browser to make a request for a resource without blocking the <code>load</code> event and while the page is downloading. Resources loaded via <code><link rel="preload"></code> are stored locally in the browser, and are effectively inert until they&#8217;re explicitly referenced in the DOM, JavaScript, or CSS.</p>
<p>Preload is different from prefetch in that it focuses on current navigation and fetches resources with priority based on their type (script, style, font, video, audio, etc.). It should be used to warm up the browser cache for current sessions.</p>
<figure><img alt="" height="234" src="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/g5fQKJMivvcsHajmMmi2.svg" width="800" loading="lazy" decoding="async"/></figure>
<h3 id="preload-full-video">Preload full video <a href="#preload-full-video" class="w-headline-link">#</a></h3>
<p>Here&#8217;s how to preload a full video on your website so that when your JavaScript asks to fetch video content, it is read from cache as the resource may have already been cached by the browser. If the preload request hasn&#8217;t finished yet, a regular network fetch will happen.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token operator"><</span>link rel<span class="token operator">=</span><span class="token string">"preload"</span> <span class="token keyword">as</span><span class="token operator">=</span><span class="token string">"video"</span> href<span class="token operator">=</span><span class="token string">"https://cdn.com/small-file.mp4"</span><span class="token operator">></span><p><span class="token operator"><</span>video id<span class="token operator">=</span><span class="token string">"video"</span> controls<span class="token operator">></span><span class="token operator"><</span><span class="token operator">/</span>video<span class="token operator">></span></p><p><span class="token operator"><</span>script<span class="token operator">></span><br/>video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'https://cdn.com/small-file.mp4'</span><span class="token punctuation">;</span><br/>video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token operator"><</span><span class="token operator">/</span>script<span class="token operator">></span></p></code></pre>
<p></web-copy-code></p>
<div class="w-aside w-aside--note">
<p>I would recommend using this only for small media files (less than 5MB).</p>
</div>
<p>Because the preloaded resource is going to be consumed by a video element in the example, the <code>as</code> preload link value is <code>video</code>. If it were an audio element, it would be <code>as="audio"</code>.</p>
<h3 id="preload-the-first-segment">Preload the first segment <a href="#preload-the-first-segment" class="w-headline-link">#</a></h3>
<p>The example below shows how to preload the first segment of a video with <code><link rel="preload"></code> and use it with Media Source Extensions. If you&#8217;re not familiar with the MSE JavaScript API, see <a href="https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API">MSE basics</a>.</p>
<p>For the sake of simplicity, let&#8217;s assume the entire video has been split into smaller files like <code>file_1.webm</code>, <code>file_2.webm</code>, <code>file_3.webm</code>, etc.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token operator"><</span>link rel<span class="token operator">=</span><span class="token string">"preload"</span> <span class="token keyword">as</span><span class="token operator">=</span><span class="token string">"fetch"</span> href<span class="token operator">=</span><span class="token string">"https://cdn.com/file_1.webm"</span><span class="token operator">></span><p><span class="token operator"><</span>video id<span class="token operator">=</span><span class="token string">"video"</span> controls<span class="token operator">></span><span class="token operator"><</span><span class="token operator">/</span>video<span class="token operator">></span></p><p><span class="token operator"><</span>script<span class="token operator">></span><br/><span class="token keyword">const</span> mediaSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>mediaSource<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>mediaSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'sourceopen'</span><span class="token punctuation">,</span> sourceOpen<span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><span class="token keyword">function</span> <span class="token function">sourceOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> mediaSource<span class="token punctuation">.</span><span class="token function">addSourceBuffer</span><span class="token punctuation">(</span><span class="token string">'video/webm; codecs="vp09.00.10.08"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><br/><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://cdn.com/file_1.webm'</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/>sourceBuffer<span class="token punctuation">.</span><span class="token function">appendBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><br/><span class="token operator"><</span><span class="token operator">/</span>script<span class="token operator">></span></p></code></pre>
<p></web-copy-code></p>
<div class="w-aside w-aside--warning">
<p><strong>Warning</strong>: For cross-origin resources, make sure your CORS headers are set properly. As we can&#8217;t create an array buffer from an opaque response retrieved with <code>fetch(videoFileUrl, { mode: 'no-cors' })</code>, we won&#8217;t be able to feed any video or audio element.</p>
</div>
<h3 id="support">Support <a href="#support" class="w-headline-link">#</a></h3>
<p>See MDN&#8217;s <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Preloading_content#Browser_compatibility">Browser compatibility</a> table to see which browsers support preload. You may want to detect its availability with the snippets below to adjust your performance metrics.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">preloadFullVideoSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>link<span class="token punctuation">.</span>as <span class="token operator">=</span> <span class="token string">'video'</span><span class="token punctuation">;</span><br/><span class="token keyword">return</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>as <span class="token operator">===</span> <span class="token string">'video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><p><span class="token keyword">function</span> <span class="token function">preloadFirstSegmentSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>link<span class="token punctuation">.</span>as <span class="token operator">=</span> <span class="token string">'fetch'</span><span class="token punctuation">;</span><br/><span class="token keyword">return</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>as <span class="token operator">===</span> <span class="token string">'fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p></code></pre>
<p></web-copy-code></p>
<h2 id="manual-buffering">Manual buffering <a href="#manual-buffering" class="w-headline-link">#</a></h2>
<p>Before we dive into the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">Cache API</a> and service workers, let&#8217;s see how to manually buffer a video with MSE. The example below assumes that your web server supports HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Range"><code>Range</code></a> requests but this would be pretty similar with file segments. Note that some middleware libraries such as <a href="https://github.com/google/shaka-player">Google&#8217;s Shaka Player</a>, <a href="https://developer.jwplayer.com/">JW Player</a>, and <a href="http://videojs.com/">Video.js</a> are built to handle this for you.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token operator"><</span>video id<span class="token operator">=</span><span class="token string">"video"</span> controls<span class="token operator">></span><span class="token operator"><</span><span class="token operator">/</span>video<span class="token operator">></span><p><span class="token operator"><</span>script<span class="token operator">></span><br/><span class="token keyword">const</span> mediaSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>mediaSource<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>mediaSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'sourceopen'</span><span class="token punctuation">,</span> sourceOpen<span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><span class="token keyword">function</span> <span class="token function">sourceOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> mediaSource<span class="token punctuation">.</span><span class="token function">addSourceBuffer</span><span class="token punctuation">(</span><span class="token string">'video/webm; codecs="vp09.00.10.08"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><br/><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'file.webm'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> headers<span class="token operator">:</span> <span class="token punctuation">{</span> range<span class="token operator">:</span> <span class="token string">'bytes=0-567139'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/>sourceBuffer<span class="token punctuation">.</span><span class="token function">appendBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>sourceBuffer<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'updateend'</span><span class="token punctuation">,</span> updateEnd<span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p><p><span class="token keyword">function</span> <span class="token function">updateEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">const</span> bufferedSeconds <span class="token operator">=</span> video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> video<span class="token punctuation">.</span>buffered<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>bufferedSeconds<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string"> seconds of video are ready to play.</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><br/>video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'playing'</span><span class="token punctuation">,</span> fetchNextSegment<span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p><p><span class="token keyword">function</span> <span class="token function">fetchNextSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'file.webm'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> headers<span class="token operator">:</span> <span class="token punctuation">{</span> range<span class="token operator">:</span> <span class="token string">'bytes=567140-1196488'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> mediaSource<span class="token punctuation">.</span>sourceBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br/>sourceBuffer<span class="token punctuation">.</span><span class="token function">appendBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><br/><span class="token operator"><</span><span class="token operator">/</span>script<span class="token operator">></span></p></code></pre>
<p></web-copy-code></p>
<h3 id="considerations">Considerations <a href="#considerations" class="w-headline-link">#</a></h3>
<p>As you&#8217;re now in control of the entire media buffering experience, I suggest you consider the device&#8217;s battery level, the &#8220;Data-Saver Mode&#8221; user preference and network information when thinking about preloading.</p>
<h4 id="battery-awareness">Battery awareness <a href="#battery-awareness" class="w-headline-link">#</a></h4>
<p>Take into account the battery level of users&#8217; devices before thinking about preloading a video. This will preserve battery life when the power level is low.</p>
<p>Disable preload or at least preload a lower resolution video when the device is running out of battery.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'getBattery'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br/>navigator<span class="token punctuation">.</span><span class="token function">getBattery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">battery</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token keyword">if</span> <span class="token punctuation">(</span>battery<span class="token punctuation">.</span>charging <span class="token operator">||</span> battery<span class="token punctuation">.</span>level <span class="token operator">></span> <span class="token number">0.15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token punctuation">}</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></code></pre>
<p></web-copy-code></p>
<h4 id="detect-"data-saver"">Detect &#8220;Data-Saver&#8221; <a href="#detect-" data-saver="" class="w-headline-link">#</a></h4>
<p>Use the <code>Save-Data</code> client hint request header to deliver fast and light applications to users who have opted-in to &#8220;data savings&#8221; mode in their browser. By identifying this request header, your application can customize and deliver an optimized user experience to cost- and performance-constrained users.</p>
<p>See <a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/save-data">Delivering Fast and Light Applications with Save-Data</a> to learn more.</p>
<h4 id="smart-loading-based-on-network-information">Smart loading based on network information <a href="#smart-loading-based-on-network-information" class="w-headline-link">#</a></h4>
<p>You may want to check <code>navigator.connection.type</code> prior to preloading. When it&#8217;s set to <code>cellular</code>, you could prevent preloading and advise users that their mobile network operator might be charging for the bandwidth, and only start automatic playback of previously cached content.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'connection'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'cellular'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br/><span class="token punctuation">}</span><br/><span class="token punctuation">}</span></code></pre>
<p></web-copy-code></p>
<p>Check out the <a href="https://googlechrome.github.io/samples/network-information/">Network Information sample</a> to learn how to react to network changes as well.</p>
<h3 id="pre-cache-multiple-first-segments">Pre-cache multiple first segments <a href="#pre-cache-multiple-first-segments" class="w-headline-link">#</a></h3>
<p>Now what if I want to speculatively pre-load some media content without knowing which piece of media the user will eventually pick? If the user is on a web page that contains 10 videos, we probably have enough memory to fetch one segment file from each but we should definitely not create 10 hidden <code><video></code> elements and 10 <code>MediaSource</code> objects and start feeding that data.</p>
<p>The two-part example below shows you how to pre-cache multiple first segments of video using the powerful and easy-to-use <a href="/cache-api-quick-guide/">Cache API</a>. Note that something similar can be achieved with IndexedDB as well. We&#8217;re not using service workers yet as the Cache API is also accessible from the <code>window</code> object.</p>
<h4 id="fetch-and-cache">Fetch and cache <a href="#fetch-and-cache" class="w-headline-link">#</a></h4>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> videoFileUrls <span class="token operator">=</span> <span class="token punctuation">[</span><br/><span class="token string">'bat_video_file_1.webm'</span><span class="token punctuation">,</span><br/><span class="token string">'cow_video_file_1.webm'</span><span class="token punctuation">,</span><br/><span class="token string">'dog_video_file_1.webm'</span><span class="token punctuation">,</span><br/><span class="token string">'fox_video_file_1.webm'</span><span class="token punctuation">,</span><br/><span class="token punctuation">]</span><span class="token punctuation">;</span><p><br/>window<span class="token punctuation">.</span>caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'video-pre-cache'</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>videoFileUrls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">videoFileUrl</span> <span class="token operator">=></span> <span class="token function">fetchAndCache</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><span class="token keyword">function</span> <span class="token function">fetchAndCache</span><span class="token punctuation">(</span><span class="token parameter">videoFileUrl<span class="token punctuation">,</span> cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cacheResponse</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token keyword">if</span> <span class="token punctuation">(</span>cacheResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">return</span> cacheResponse<span class="token punctuation">;</span><br/><span class="token punctuation">}</span><br/><span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">networkResponse</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/>cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">,</span> networkResponse<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token keyword">return</span> networkResponse<span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p></code></pre>
<p></web-copy-code></p>
<p>Note that if I were to use HTTP <code>Range</code> requests, I would have to manually recreate a <code>Response</code> object as the Cache API doesn&#8217;t support <code>Range</code> responses <a href="https://github.com/whatwg/fetch/issues/144">yet</a>. Be mindful that calling <code>networkResponse.arrayBuffer()</code> fetches the whole content of the response at once into renderer memory, which is why you may want to use small ranges.</p>
<p>For reference, I&#8217;ve modified part of the example above to save HTTP Range requests to the video precache.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js">    <span class="token operator">...</span><br/><span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers<span class="token operator">:</span> <span class="token punctuation">{</span> range<span class="token operator">:</span> <span class="token string">'bytes=0-567139'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">networkResponse</span> <span class="token operator">=></span> networkResponse<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token keyword">return</span> response<span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p></web-copy-code></p>
<h4 id="play-video">Play video <a href="#play-video" class="w-headline-link">#</a></h4>
<p>When a user clicks a play button, we&#8217;ll fetch the first segment of video available in the Cache API so that playback starts immediately if available. Otherwise, we&#8217;ll simply fetch it from the network. Keep in mind that browsers and users may decide to clear the <a href="/storage-for-the-web/#eviction">Cache</a>.</p>
<p>As seen before, we use MSE to feed that first segment of video to the video element.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">onPlayButtonClick</span><span class="token punctuation">(</span><span class="token parameter">videoFileUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/>video<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <p>window<span class="token punctuation">.</span>caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'video-pre-cache'</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=></span> <span class="token function">fetchAndCache</span><span class="token punctuation">(</span>videoFileUrl<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">)</span> <br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token keyword">const</span> mediaSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>mediaSource<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>mediaSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'sourceopen'</span><span class="token punctuation">,</span> sourceOpen<span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><span class="token keyword">function</span> <span class="token function">sourceOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> mediaSource<span class="token punctuation">.</span><span class="token function">addSourceBuffer</span><span class="token punctuation">(</span><span class="token string">'video/webm; codecs="vp09.00.10.08"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/>sourceBuffer<span class="token punctuation">.</span><span class="token function">appendBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></p><p>video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p></code></pre>
<p></web-copy-code></p>
<div class="w-aside w-aside--warning">
<p><strong>Warning</strong>: For cross-origin resources, make sure your CORS headers are set properly. As we can&#8217;t create an array buffer from an opaque response retrieved with <code>fetch(videoFileUrl, { mode: 'no-cors' })</code>, we won&#8217;t be able to feed any video or audio element.</p>
</div>
<h3 id="create-range-responses-with-a-service-worker">Create Range responses with a service worker <a href="#create-range-responses-with-a-service-worker" class="w-headline-link">#</a></h3>
<p>Now what if you have fetched an entire video file and saved it in the Cache API? When the browser sends an HTTP <code>Range</code> request, you certainly don&#8217;t want to bring the entire video into renderer memory as the Cache API doesn&#8217;t support <code>Range</code> responses <a href="https://github.com/whatwg/fetch/issues/144">yet</a>.</p>
<p>So let me show how to intercept these requests and return a customized <code>Range</code> response from a service worker.</p>
<p><web-copy-code></p>
<pre class="language-js"><code class="language-js"><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br/>event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">loadFromCacheOrFetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><p><span class="token keyword">function</span> <span class="token function">loadFromCacheOrFetch</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> <span class="token punctuation">{</span></p><p><br/><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p><p><br/><span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br/><span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br/><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span></p><p><br/><span class="token keyword">const</span> pos <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">^bytes=(d+)-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><br/>status<span class="token operator">:</span> <span class="token number">206</span><span class="token punctuation">,</span><br/>statusText<span class="token operator">:</span> <span class="token string">'Partial Content'</span><span class="token punctuation">,</span><br/>headers<span class="token operator">:</span> response<span class="token punctuation">.</span>headers<br/><span class="token punctuation">}</span><br/><span class="token keyword">const</span> slicedResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>slicedResponse<span class="token punctuation">.</span><span class="token function">setHeaders</span><span class="token punctuation">(</span><span class="token string">'Content-Range'</span><span class="token operator">:</span> <span class="token string">'bytes '</span> <span class="token operator">+</span> pos <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span><br/><span class="token punctuation">(</span>data<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><br/>slicedResponse<span class="token punctuation">.</span><span class="token function">setHeaders</span><span class="token punctuation">(</span><span class="token string">'X-From-Cache'</span><span class="token operator">:</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></p><p><span class="token keyword">return</span> slicedResponse<span class="token punctuation">;</span><br/><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br/><span class="token punctuation">}</span></p><p><span class="token keyword">return</span> response<span class="token punctuation">;</span><br/><span class="token punctuation">}</span><br/><span class="token punctuation">}</span></p></code></pre>
<p></web-copy-code></p>
<p>It is important to note that I used <code>response.blob()</code> to recreate this sliced response as this simply gives me a handle to the file while <code>response.arrayBuffer()</code> brings the entire file into renderer memory.</p>
<p>My custom <code>X-From-Cache</code> HTTP header can be used to know whether this request came from the cache or from the network. It can be used by a player such as <a href="https://github.com/google/shaka-player/blob/master/docs/tutorials/service-worker.md">ShakaPlayer</a> to ignore the response time as an indicator of network speed.</p>
<p>Have a look at the official <a href="https://github.com/GoogleChrome/sample-media-pwa">Sample Media App</a> and in particular its <a href="https://github.com/GoogleChrome/sample-media-pwa/blob/master/src/client/scripts/ranged-response.js">ranged-response.js</a> file for a complete solution for how to handle <code>Range</code> requests.</p>
<div class="w-mb--l w-mt--l w-post-github-link"><span class="w-mr--sm">Last updated: <time>Nov 16, 2020</time></span><a href="https://github.com/GoogleChrome/web.dev/blob/master/src/site/content/en/blog/fast-playback-with-preload/index.md">Improve article</a></div>
<p><web-feedback additional-questions=""/></div>
]]></content:encoded>
					
					<wfw:commentRss>https://sadewadee.pages.dev/en/fast-playback-with-audio-and-video-preload/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		<enclosure url="https://storage.googleapis.com/web-dev-assets/fast-playback-with-preload/video-preload-hero.webm" length="329399" type="video/webm" />
<enclosure url="https://storage.googleapis.com/web-dev-assets/fast-playback-with-preload/video-preload-hero.mp4" length="1855752" type="video/mp4" />

			</item>
		<item>
		<title>Hello world!</title>
		<link>https://sadewadee.pages.dev/en/hello-world/</link>
					<comments>https://sadewadee.pages.dev/en/hello-world/#comments</comments>
		
		<dc:creator><![CDATA[sadewadee]]></dc:creator>
		<pubDate>Fri, 04 Jun 2021 05:26:51 +0000</pubDate>
				<category><![CDATA[Uncategorized]]></category>
		<guid isPermaLink="false">http://optinlabs.my.id/blogs/?p=1</guid>

					<description><![CDATA[Welcome to WordPress. This is your first post. Edit or delete it, then start writing!<a class="read-more" href="https://sadewadee.pages.dev/en/hello-world/" title="More"> <span class="button"> Read More</span></a>]]></description>
										<content:encoded><![CDATA[
<p>Welcome to WordPress. This is your first post. Edit or delete it, then start writing!</p>
]]></content:encoded>
					
					<wfw:commentRss>https://sadewadee.pages.dev/en/hello-world/feed/</wfw:commentRss>
			<slash:comments>1</slash:comments>
		
		
			</item>
	</channel>
</rss>
